{"version":3,"file":"EntityManager.js","names":["Duration","_interopRequireWildcard","require","HashMap","HashSet","Option","Effect","Fiber","RefSynchronized","Scope","PoisonPill","ShardError","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","layerScope","recipientType","behaviour_","sharding","config","messageQueue","entityMaxIdle","gen","_","entities","empty","env","context","behaviour","entityId","dequeue","provideContext","startExpirationFiber","forkDaemon","interruptible","asUnit","zipRight","forkEntityTermination","sleep","getOrElse","entityMaxIdleTime","modifyEffect","map","match","onNone","succeed","none","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","as","offer","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","entityScope","extend","executionFiber","ensuring","interrupt","update","remove","use","someQueue","interruptionFiber","fiber","tap","millis","catchAllCause","e","logDebug","zipLeft","end","replyId_","initReply","test","bind","_tag","unlessEffect","isEntityOnLocalShards","unit","die","Do","terminateAllEntities","terminateEntities","keySet","entitiesToTerminate","forEach","logError","name","toMillis","entityTerminationTimeout","timeout","await","concurrency","terminateEntitiesOnShards","shards","modify","filter","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}