{"version":3,"file":"EntityManager.js","names":["Duration","_interopRequireWildcard","require","_Function","HashMap","HashSet","Option","Deferred","Effect","Fiber","Queue","RefSynchronized","ShardError","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","recipientType","behavior_","terminateMessage","sharding","config","entityMaxIdle","gen","$","entities","empty","env","context","behavior","entityId","dequeue","provideContext","startExpirationFiber","pipe","sleep","getOrElse","entityMaxIdleTime","zipRight","terminateEntity","forkDaemon","asUnit","interruptible","updateEffect","map","match","onNone","succeed","onSome","maybeQueue","interruptionFiber","queue","flatMap","p","as","shutdown","remove","msg","offer","exit","none","send","req","replyId","replyChannel","decide","test","isSome","value","interrupt","fiber","isNone","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","Do","bind","unbounded","tap","_","ensuring","update","expirationFiber","let","some","someQueue","_tag","unlessEffect","isEntityOnLocalShards","unit","die","modifyEffect","millis","zipLeft","end","replyId_","initReply","catchAllCause","e","logCause","message","terminateAllEntities","getAndSet","terminateEntities","entitiesToTerminate","forEach","queue_","__","terminate","promises","timeout","await","discard","entityTerminationTimeout","terminateEntitiesOnShards","shards","modify","filter","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}