{"version":3,"file":"EntityManager.js","names":["Duration","_interopRequireWildcard","require","HashMap","HashSet","Option","Effect","Fiber","RefSynchronized","Scope","MessageQueue","PoisonPill","ShardError","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entities","empty","behaviour","entityId","dequeue","provideContext","startExpirationFiber","forkDaemon","interruptible","asUnit","zipRight","forkEntityTermination","sleep","getOrElse","modifyEffect","map","match","onNone","succeed","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","as","offer","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","entityScope","extend","executionFiber","ensuring","interrupt","update","remove","use","interruptionFiber","fiber","tap","millis","messageQueue","catchAllCause","e","logDebug","zipLeft","end","replyId_","initReply","test","bind","_tag","unlessEffect","isEntityOnLocalShards","unit","die","Do","terminateAllEntities","terminateEntities","keySet","entitiesToTerminate","forEach","logError","name","toMillis","entityTerminationTimeout","timeout","await","concurrency","terminateEntitiesOnShards","shards","modify","filter","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}