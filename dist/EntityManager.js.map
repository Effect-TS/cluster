{"version":3,"file":"EntityManager.js","names":["Duration","_interopRequireWildcard","require","HashMap","HashSet","Option","Deferred","Effect","Fiber","Queue","RefSynchronized","ShardError","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","recipientType","behavior_","terminateMessage","sharding","config","entityMaxIdle","gen","$","entities","empty","env","context","behavior","entityId","dequeue","provideContext","startExpirationFiber","forkDaemon","interruptible","zipRight","asUnit","terminateEntity","sleep","getOrElse","entityMaxIdleTime","updateEffect","map","match","onNone","succeed","onSome","maybeQueue","interruptionFiber","queue","flatMap","p","as","shutdown","remove","msg","exit","offer","none","send","req","replyId","replyChannel","decide","test","isSome","value","fiber","interrupt","isNone","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","_","someQueue","expirationFiber","let","some","tap","ensuring","update","bind","unbounded","Do","millis","catchAllCause","e","logCause","message","zipLeft","end","replyId_","initReply","modifyEffect","_tag","unlessEffect","isEntityOnLocalShards","unit","die","terminateAllEntities","getAndSet","terminateEntities","entitiesToTerminate","promises","timeout","forEach","await","discard","entityTerminationTimeout","queue_","__","terminate","terminateEntitiesOnShards","shards","modify","filter","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}