{"version":3,"file":"EntityManager.js","names":["Duration","_interopRequireWildcard","require","HashMap","HashSet","Option","Effect","Fiber","Queue","RefSynchronized","PoisonPill","ShardError","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","layerScope","recipientType","recipientBehaviour","sharding","config","entityMaxIdle","gen","$","entities","empty","env","context","behavior","entityId","dequeue","provideContext","accept","msg","startExpirationFiber","forkDaemon","interruptible","asUnit","zipRight","forkEntityTermination","sleep","getOrElse","entityMaxIdleTime","modifyEffect","map","match","onNone","succeed","none","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","as","offer","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","_","unbounded","executionFiber","ensuring","interrupt","shutdown","update","remove","someQueue","interruptionFiber","fiber","tap","millis","catchAllCause","e","logDebug","zipLeft","end","replyId_","initReply","test","bind","_tag","unlessEffect","isEntityOnLocalShards","unit","die","Do","terminateAllEntities","terminateEntities","keySet","entitiesToTerminate","forEach","logError","name","toMillis","entityTerminationTimeout","timeout","await","concurrency","terminateEntitiesOnShards","shards","modify","filter","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}