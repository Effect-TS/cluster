{"version":3,"file":"EntityManager.mjs","names":["Duration","HashMap","HashSet","Option","Effect","Fiber","RefSynchronized","Scope","MessageQueue","PoisonPill","ShardError","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entities","empty","behaviour","entityId","dequeue","provideContext","startExpirationFiber","forkDaemon","interruptible","asUnit","zipRight","forkEntityTermination","sleep","getOrElse","modifyEffect","map","match","onNone","succeed","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","as","set","offer","get","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","entityScope","extend","executionFiber","ensuring","interrupt","update","remove","use","interruptionFiber","fiber","tap","millis","messageQueue","catchAllCause","e","logDebug","zipLeft","end","replyId_","initReply","test","bind","_tag","unlessEffect","isEntityOnLocalShards","unit","die","Do","terminateAllEntities","terminateEntities","keySet","entitiesToTerminate","forEach","logError","name","toMillis","entityTerminationTimeout","timeout","await","concurrency","terminateEntitiesOnShards","shards","modify","filter","has","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}