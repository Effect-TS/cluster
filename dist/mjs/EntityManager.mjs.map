{"version":3,"file":"EntityManager.mjs","names":["Duration","pipe","HashMap","HashSet","Option","Deferred","Effect","Fiber","Queue","RefSynchronized","ShardError","make","recipientType","behavior_","terminateMessage","sharding","config","entityMaxIdle","gen","$","entities","empty","env","context","behavior","entityId","dequeue","provideContext","startExpirationFiber","sleep","getOrElse","entityMaxIdleTime","zipRight","terminateEntity","forkDaemon","asUnit","interruptible","updateEffect","map","get","match","onNone","succeed","onSome","maybeQueue","interruptionFiber","queue","flatMap","p","as","shutdown","remove","msg","offer","exit","set","none","send","req","replyId","replyChannel","decide","test","isSome","value","interrupt","fiber","isNone","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","Do","bind","unbounded","tap","_","ensuring","update","expirationFiber","let","some","someQueue","_tag","unlessEffect","isEntityOnLocalShards","unit","die","modifyEffect","millis","zipLeft","end","replyId_","initReply","catchAllCause","e","logCause","message","terminateAllEntities","getAndSet","terminateEntities","entitiesToTerminate","forEach","queue_","__","terminate","promises","timeout","await","discard","entityTerminationTimeout","terminateEntitiesOnShards","shards","modify","filter","has","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}