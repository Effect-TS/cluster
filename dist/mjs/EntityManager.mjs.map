{"version":3,"file":"EntityManager.mjs","names":["Duration","HashMap","HashSet","Option","Deferred","Effect","Fiber","Queue","RefSynchronized","ShardError","make","recipientType","behavior_","terminateMessage","sharding","config","entityMaxIdle","gen","$","entities","empty","env","context","behavior","entityId","dequeue","provideContext","startExpirationFiber","forkDaemon","interruptible","zipRight","asUnit","terminateEntity","sleep","getOrElse","entityMaxIdleTime","updateEffect","map","match","onNone","succeed","onSome","maybeQueue","interruptionFiber","queue","flatMap","p","as","shutdown","remove","msg","exit","offer","set","none","get","send","req","replyId","replyChannel","decide","test","isSome","value","fiber","interrupt","isNone","isShuttingDown","isGoingDown","fail","EntityNotManagedByThisPod","_","unbounded","expirationFiber","catchAllCause","ensuring","update","logError","someQueue","some","tap","millis","e","logDebug","zipLeft","end","replyId_","initReply","bind","modifyEffect","_tag","unlessEffect","isEntityOnLocalShards","unit","die","Do","terminateAllEntities","getAndSet","terminateEntities","entitiesToTerminate","promises","timeout","forEach","await","discard","entityTerminationTimeout","queue_","__","terminate","terminateEntitiesOnShards","shards","modify","filter","has","getShardId","self"],"sources":["../../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}