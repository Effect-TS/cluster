{"version":3,"file":"ShardManager.mjs","names":["HashMap","Chunk","Tag","equals","HashSet","List","Option","Clock","Effect","Hub","Layer","RefSynchronized","Schedule","ManagerConfig","PodAddress","Pods","PodsHealth","PodWithMetadata","ShardId","ShardingPodNoLongerRegisteredError","ShardingEvent","ShardManagerState","Storage","Stream","groupBy","minByOption","showHashSet","ShardManager","make","layerScope","stateRef","rebalanceSemaphore","eventsHub","healthApi","podApi","stateRepository","config","getAssignments","map","_","shards","get","getShardingEvents","fromHub","register","pod","asUnit","zipRight","forkIn","persistPods","flatMap","state","when","rebalance","size","unassignedShards","zipLeft","publish","PodRegistered","address","updateAndGetEffect","cdt","set","pods","clock","currentTimeMillis","logInfo","show","version","stateHasPod","podAddress","has","notifyUnhealthyPod","whenEffect","unlessEffect","logWarning","unregister","isAlive","PodHealthChecked","checkAllPodsHealth","forEach","concurrency","discard","keySet","eff","tap","ShardsUnassigned","unassignments","PodUnregistered","bind","modify","filter","some","remove","none","Do","withRetry","zio","ignore","retry","andThen","recurs","persistRetryCount","spaced","persistRetryInterval","persistAssignments","saveAssignments","savePods","v","updateShardsState","updateEffect","isSome","value","fail","succeed","assignment","shard","rebalanceImmediately","algo","gen","assignments","decideAssignmentsForUnassignedShards","decideAssignmentsForUnbalancedShards","rebalanceRate","areChanges","logDebug","JSON","stringify","failedPingedPods","union","match","onFailure","fromIterable","onSuccess","empty","onNone","onSome","timeout","pingTimeout","ping","flatten","shardsToRemove","__","appendAll","readyAssignments","difference","readyUnassignments","failedUnassignedPods","failedUnassignedShards","matchEffect","as","unassignShards","unzip","filteredAssignments","removeMany","failedAssignedPods","ShardsAssigned","assignShards","failedPods","sleep","rebalanceRetryInterval","withPermits","pickNewPods","extraShardsToAllocate","allPodsHaveMaxVersion","extraShards","Math","max","averageShardsPerPod","take","shardsPerPod","sortedShardsToRebalance","shardsToRebalance","reduce","unassignedPods","toArray","oldPod","Number","MAX_SAFE_INTEGER","unassigned","add","prepend","findFirst","p","maxVersion","isNone","getOrElse","compareVersion","extractVersion","of","assignmentsPerPod","shardId","unassignmentsPerPod","live","podsApi","scope","getPods","filteredPods","initialState","n","range","numberOfShards","makeSemaphore","unbounded","shardManager","repeat","rebalanceInterval","mapEffect","runDrain","pipe","scoped"],"sources":["../../src/ShardManager.ts"],"sourcesContent":[null],"mappings":"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"}