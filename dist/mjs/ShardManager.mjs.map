{"version":3,"file":"ShardManager.mjs","names":["HashMap","Chunk","Tag","equals","HashSet","List","Option","Clock","Effect","Hub","Layer","RefSynchronized","Schedule","ManagerConfig","PodAddress","Pods","PodsHealth","PodWithMetadata","ShardError","ShardId","ShardingEvent","ShardManagerState","Storage","Stream","groupBy","minByOption","showHashSet","ShardManager","make","stateRef","rebalanceSemaphore","eventsHub","healthApi","podApi","stateRepository","config","getAssignments","map","_","shards","get","getShardingEvents","fromHub","register","pod","asUnit","zipRight","forkDaemon","persistPods","flatMap","state","when","rebalance","size","unassignedShards","zipLeft","publish","PodRegistered","address","updateAndGetEffect","cdt","set","pods","clock","currentTimeMillis","logInfo","show","version","stateHasPod","podAddress","has","notifyUnhealthyPod","whenEffect","unlessEffect","logWarning","unregister","isAlive","PodHealthChecked","checkAllPodsHealth","forEach","concurrency","discard","keySet","eff","tap","ShardsUnassigned","unassignments","PodUnregistered","bind","modify","filter","some","remove","none","Do","withRetry","zio","ignore","retry","andThen","recurs","persistRetryCount","spaced","persistRetryInterval","persistAssignments","saveAssignments","savePods","v","updateShardsState","updateEffect","isSome","value","fail","PodNoLongerRegistered","succeed","assignment","shard","rebalanceImmediately","algo1","let","fromIterable","__","failedPingedPods","appendAll","assignments","flatten","union","match","onFailure","onSuccess","empty","onNone","onSome","timeout","pingTimeout","ping","logDebug","JSON","stringify","areChanges","_1","decideAssignmentsForUnassignedShards","decideAssignmentsForUnbalancedShards","rebalanceRate","algo2","failedPods","sleep","rebalanceRetryInterval","failedAssignedPods","failedUnassignedPods","filteredAssignments","matchEffect","as","ShardsAssigned","assignShards","difference","failedUnassignedShards","removeMany","readyAssignments","failed","unzip","readyUnassignments","unassignShards","shardsToRemove","withPermits","pickNewPods","extraShardsToAllocate","allPodsHaveMaxVersion","extraShards","Math","max","averageShardsPerPod","take","shardsPerPod","sortedShardsToRebalance","shardsToRebalance","reduce","unassignedPods","toArray","oldPod","Number","MAX_SAFE_INTEGER","unassigned","add","prepend","findFirst","p","maxVersion","isNone","getOrElse","compareVersion","extractVersion","of","assignmentsPerPod","shardId","unassignmentsPerPod","live","gen","podsApi","getPods","filteredPods","initialState","n","range","numberOfShards","makeSemaphore","unbounded","shardManager","repeat","rebalanceInterval","mapEffect","runDrain","pipe","effect"],"sources":["../../src/ShardManager.ts"],"sourcesContent":[null],"mappings":"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"}