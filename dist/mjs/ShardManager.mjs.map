{"version":3,"file":"ShardManager.mjs","names":["HashMap","Chunk","Tag","equals","HashSet","List","Option","Clock","Effect","Hub","Layer","RefSynchronized","Schedule","ManagerConfig","PodAddress","Pods","PodsHealth","PodWithMetadata","ShardError","ShardId","ShardingEvent","ShardManagerState","Storage","Stream","groupBy","minByOption","showHashSet","ShardManager","make","layerScope","stateRef","rebalanceSemaphore","eventsHub","healthApi","podApi","stateRepository","config","getAssignments","map","_","shards","get","getShardingEvents","fromHub","register","pod","asUnit","zipRight","forkIn","persistPods","flatMap","state","when","rebalance","size","unassignedShards","zipLeft","publish","PodRegistered","address","updateAndGetEffect","cdt","set","pods","clock","currentTimeMillis","logInfo","show","version","stateHasPod","podAddress","has","notifyUnhealthyPod","whenEffect","unlessEffect","logWarning","unregister","isAlive","PodHealthChecked","checkAllPodsHealth","forEach","concurrency","discard","keySet","eff","tap","ShardsUnassigned","unassignments","PodUnregistered","bind","modify","filter","some","remove","none","Do","withRetry","zio","ignore","retry","andThen","recurs","persistRetryCount","spaced","persistRetryInterval","persistAssignments","saveAssignments","savePods","v","updateShardsState","updateEffect","isSome","value","fail","PodNoLongerRegistered","succeed","assignment","shard","rebalanceImmediately","algo","gen","assignments","decideAssignmentsForUnassignedShards","decideAssignmentsForUnbalancedShards","rebalanceRate","areChanges","logDebug","JSON","stringify","failedPingedPods","union","match","onFailure","fromIterable","onSuccess","empty","onNone","onSome","timeout","pingTimeout","ping","flatten","shardsToRemove","__","appendAll","readyAssignments","difference","readyUnassignments","failedUnassignedPods","failedUnassignedShards","matchEffect","as","unassignShards","unzip","filteredAssignments","removeMany","failedAssignedPods","ShardsAssigned","assignShards","failedPods","sleep","rebalanceRetryInterval","withPermits","pickNewPods","extraShardsToAllocate","allPodsHaveMaxVersion","extraShards","Math","max","averageShardsPerPod","take","shardsPerPod","sortedShardsToRebalance","shardsToRebalance","reduce","unassignedPods","toArray","oldPod","Number","MAX_SAFE_INTEGER","unassigned","add","prepend","findFirst","p","maxVersion","isNone","getOrElse","compareVersion","extractVersion","of","assignmentsPerPod","shardId","unassignmentsPerPod","live","podsApi","scope","getPods","filteredPods","initialState","n","range","numberOfShards","makeSemaphore","unbounded","shardManager","repeat","rebalanceInterval","mapEffect","runDrain","pipe","scoped"],"sources":["../../src/ShardManager.ts"],"sourcesContent":[null],"mappings":"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"}