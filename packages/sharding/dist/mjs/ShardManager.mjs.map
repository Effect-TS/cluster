{"version":3,"file":"ShardManager.mjs","names":["ManagerConfig","PodAddress","Pods","PodsHealth","PodWithMetadata","ShardId","ShardingErrorPodNoLongerRegistered","ShardingEvent","ShardManagerState","Storage","Chunk","Clock","Tag","Effect","equals","pipe","HashMap","HashSet","Hub","Layer","List","Option","Schedule","Stream","RefSynchronized","groupBy","minByOption","showHashSet","ShardManager","make","layerScope","stateRef","rebalanceSemaphore","eventsHub","healthApi","podApi","stateRepository","config","getAssignments","get","map","_","shards","getShardingEvents","fromHub","register","pod","logInfo","show","address","version","zipRight","updateAndGetEffect","state","flatMap","clock","currentTimeMillis","cdt","set","pods","zipLeft","publish","PodRegistered","when","rebalance","size","unassignedShards","forkIn","persistPods","asUnit","stateHasPod","podAddress","has","notifyUnhealthyPod","whenEffect","PodHealthChecked","unlessEffect","logWarning","unregister","isAlive","checkAllPodsHealth","keySet","forEach","concurrency","discard","eff","Do","bind","modify","filter","some","remove","none","tap","PodUnregistered","ShardsUnassigned","unassignments","withRetry","zio","retry","spaced","persistRetryInterval","andThen","recurs","persistRetryCount","ignore","persistAssignments","saveAssignments","savePods","v","updateShardsState","updateEffect","isSome","value","fail","succeed","assignment","shard","rebalanceImmediately","algo","gen","assignments","decideAssignmentsForUnassignedShards","decideAssignmentsForUnbalancedShards","rebalanceRate","areChanges","logDebug","JSON","stringify","failedPingedPods","union","ping","timeout","pingTimeout","match","onNone","onSome","onFailure","fromIterable","onSuccess","empty","flatten","shardsToRemove","appendAll","__","readyAssignments","difference","readyUnassignments","failedUnassignedPods","failedUnassignedShards","unassignShards","matchEffect","as","unzip","filteredAssignments","removeMany","failedAssignedPods","assignShards","ShardsAssigned","failedPods","sleep","rebalanceRetryInterval","withPermits","pickNewPods","extraShardsToAllocate","allPodsHaveMaxVersion","shardsPerPod","extraShards","Math","max","averageShardsPerPod","take","sortedShardsToRebalance","shardsToRebalance","reduce","unassignedPods","toArray","maxVersion","isNone","extractVersion","compareVersion","getOrElse","p","findFirst","oldPod","Number","MAX_SAFE_INTEGER","unassigned","add","prepend","of","assignmentsPerPod","shardId","unassignmentsPerPod","live","podsApi","scope","getPods","filteredPods","initialState","range","numberOfShards","n","makeSemaphore","unbounded","shardManager","repeat","rebalanceInterval","mapEffect","runDrain","scoped"],"sources":["../src/ShardManager.ts"],"sourcesContent":[null],"mappings":"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"}