{"version":3,"file":"EntityManager.mjs","names":["MessageQueue","PoisonPill","ShardingError","Duration","Effect","Fiber","pipe","HashMap","HashSet","Option","RefSynchronized","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entities","empty","behaviour","recipientContext","provide","startExpirationFiber","entityId","sleep","getOrElse","zipRight","forkEntityTermination","asUnit","interruptible","forkDaemon","modifyEffect","map","get","match","onNone","succeed","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","offer","catchAllCause","logError","as","set","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","ShardingErrorEntityNotManagedByThisPod","executionFiber","dequeue","reply","message","replier","replyStream","ensuring","update","remove","shutdown","interrupt","interruptionFiber","fiber","Do","tap","_tag","unlessEffect","isEntityOnLocalShards","unit","die","bind","test","millis","messageQueue","zipLeft","end","replyId_","initReply","terminateAllEntities","keySet","terminateEntities","entitiesToTerminate","forEach","logDebug","await","timeout","entityTerminationTimeout","name","toMillis","concurrency","terminateEntitiesOnShards","shards","modify","filter","has","getShardId","self"],"sources":["../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}