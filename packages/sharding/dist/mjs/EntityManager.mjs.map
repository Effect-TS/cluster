{"version":3,"file":"EntityManager.mjs","names":["Duration","HashMap","HashSet","Option","Effect","Fiber","RefSynchronized","MessageQueue","PoisonPill","ShardingError","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entities","empty","behaviour","recipientContext","provideContext","startExpirationFiber","entityId","forkDaemon","interruptible","asUnit","zipRight","forkEntityTermination","sleep","getOrElse","modifyEffect","map","match","onNone","succeed","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","as","set","catchAllCause","logError","offer","get","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","ShardingErrorEntityNotManagedByThisPod","provideSomeContext","executionFiber","ensuring","interrupt","shutdown","update","remove","dequeue","reply","message","replier","replyStream","interruptionFiber","fiber","tap","millis","messageQueue","zipLeft","end","replyId_","initReply","test","bind","_tag","unlessEffect","isEntityOnLocalShards","unit","die","Do","terminateAllEntities","terminateEntities","keySet","entitiesToTerminate","forEach","name","toMillis","entityTerminationTimeout","logDebug","timeout","await","concurrency","terminateEntitiesOnShards","shards","modify","filter","has","getShardId","self"],"sources":["../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}