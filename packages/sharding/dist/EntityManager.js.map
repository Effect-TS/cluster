{"version":3,"file":"EntityManager.js","names":["Duration","_interopRequireWildcard","require","HashMap","HashSet","Option","Effect","Fiber","RefSynchronized","MessageQueue","PoisonPill","ShardingError","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entities","empty","behaviour","recipientContext","provideContext","startExpirationFiber","entityId","forkDaemon","interruptible","asUnit","zipRight","forkEntityTermination","sleep","getOrElse","modifyEffect","map","match","onNone","succeed","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","as","catchAllCause","logError","offer","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","ShardingErrorEntityNotManagedByThisPod","provideSomeContext","executionFiber","ensuring","interrupt","shutdown","update","remove","dequeue","reply","message","replier","replyStream","interruptionFiber","fiber","tap","millis","messageQueue","zipLeft","end","replyId_","initReply","test","bind","_tag","unlessEffect","isEntityOnLocalShards","unit","die","Do","terminateAllEntities","terminateEntities","keySet","entitiesToTerminate","forEach","name","toMillis","entityTerminationTimeout","logDebug","timeout","await","concurrency","terminateEntitiesOnShards","shards","modify","filter","getShardId","self"],"sources":["./src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}