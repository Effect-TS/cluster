{"version":3,"file":"EntityManager.js","names":["MessageQueue","_interopRequireWildcard","require","PoisonPill","ShardingError","Duration","Effect","Fiber","_Function","HashMap","HashSet","Option","RefSynchronized","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entities","empty","behaviour","recipientContext","provide","startExpirationFiber","entityId","pipe","sleep","getOrElse","zipRight","forkEntityTermination","asUnit","interruptible","forkDaemon","modifyEffect","map","match","onNone","succeed","onSome","maybeQueue","expirationFiber","runningFiber","some","queue","offer","catchAllCause","logError","as","send","req","replyId","replyChannel","decide","flatMap","isShuttingDown","isGoingDown","fail","ShardingErrorEntityNotManagedByThisPod","executionFiber","dequeue","reply","message","replier","replyStream","ensuring","update","remove","shutdown","interrupt","interruptionFiber","fiber","Do","tap","_tag","unlessEffect","isEntityOnLocalShards","unit","die","bind","test","millis","messageQueue","zipLeft","end","replyId_","initReply","terminateAllEntities","keySet","terminateEntities","entitiesToTerminate","forEach","logDebug","await","timeout","entityTerminationTimeout","name","toMillis","concurrency","terminateEntitiesOnShards","shards","modify","filter","getShardId","self"],"sources":["./src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}