{"version":3,"file":"EntityManager.mjs","names":["EntityState","MessageQueue","PoisonPill","RecipientBehaviour","ReplyChannel","ShardingError","Cause","Duration","Effect","Fiber","pipe","HashMap","HashSet","Option","RefSynchronized","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entityStates","empty","replyChannels","initReply","id","replyChannel","update","set","zipLeft","await","ensuring","remove","fork","reply","replyId","updateEffect","repliers","suspend","get","isSome","value","unit","as","startExpirationFiber","entityId","sleep","getOrElse","zipRight","forkEntityTermination","asUnit","interruptible","forkDaemon","modifyEffect","entityStatesMap","match","onNone","succeed","onSome","entityState","messageQueue","some","executionFiber","queue","offer","catchAllCause","logError","modify","withoutMessageQueue","send","req","decide","map","flatMap","isShuttingDown","isGoingDown","fail","ShardingErrorEntityNotManagedByThisPod","provide","expirationFiber","dequeue","provideService","RecipientBehaviourContext","shutdown","interrupt","forEach","fiber","withExpirationFiber","Do","tap","_tag","unlessEffect","isEntityOnLocalShards","die","bind","test","millis","replyId_","output","unified","terminateAllEntities","keySet","terminateEntities","entitiesToTerminate","logDebug","timeout","entityTerminationTimeout","name","toMillis","concurrency","terminateEntitiesOnShards","shards","entities","filter","has","getShardId","self"],"sources":["../src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}