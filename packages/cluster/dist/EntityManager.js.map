{"version":3,"file":"EntityManager.js","names":["EntityState","_interopRequireWildcard","require","MessageQueue","PoisonPill","RecipientBehaviour","ReplyChannel","ShardingError","Cause","Duration","Effect","Fiber","_Function","HashMap","HashSet","Option","RefSynchronized","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","make","recipientType","behaviour_","sharding","config","options","gen","_","entityMaxIdle","entityMaxIdleTime","none","messageQueueConstructor","inMemory","env","context","entityStates","empty","replyChannels","initReply","id","replyChannel","pipe","update","zipLeft","await","ensuring","remove","fork","reply","replyId","updateEffect","repliers","suspend","isSome","value","unit","as","startExpirationFiber","entityId","sleep","getOrElse","zipRight","forkEntityTermination","asUnit","interruptible","forkDaemon","modifyEffect","entityStatesMap","match","onNone","succeed","onSome","entityState","messageQueue","some","executionFiber","queue","offer","catchAllCause","logError","modify","withoutMessageQueue","send","req","decide","map","flatMap","isShuttingDown","isGoingDown","fail","ShardingErrorEntityNotManagedByThisPod","provide","expirationFiber","dequeue","provideService","RecipientBehaviourContext","shutdown","interrupt","forEach","fiber","withExpirationFiber","Do","tap","_tag","unlessEffect","isEntityOnLocalShards","die","bind","test","millis","replyId_","output","unified","terminateAllEntities","keySet","terminateEntities","entitiesToTerminate","logDebug","timeout","entityTerminationTimeout","name","toMillis","concurrency","terminateEntitiesOnShards","shards","entities","filter","getShardId","self"],"sources":["./src/EntityManager.ts"],"sourcesContent":[null],"mappings":"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"}